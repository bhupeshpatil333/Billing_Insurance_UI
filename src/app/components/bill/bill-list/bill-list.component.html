<div class="space-y-6">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Generate Bill</h1>
        <p class="text-gray-600">Create a new bill with automatic insurance calculation</p>
    </div>

    <!-- Patient Selection Card -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="text-2xl mr-2">üë§</span>
            Patient Details
        </h3>

        <mat-form-field class="w-full">
            <mat-label>Select Patient</mat-label>
            <mat-select [(ngModel)]="patientId" (selectionChange)="onPatientChange()" required name="patientSelect">
                <mat-option *ngFor="let p of patients" [value]="p.patientId">
                    {{ p.fullName }}
                </mat-option>
            </mat-select>
            <mat-error>Please select a patient to generate a bill</mat-error>
        </mat-form-field>

        <div *ngIf="insuranceCoverage > 0" class="mt-4 bg-green-50 border-l-4 border-green-500 p-4 rounded">
            <div class="flex items-center">
                <span class="text-2xl mr-3">üè•</span>
                <div>
                    <p class="text-sm font-semibold text-green-900">Insurance Coverage Active</p>
                    <p class="text-lg font-bold text-green-700">{{ insuranceCoverage }}% Coverage</p>
                </div>
            </div>
        </div>

        <div *ngIf="patientId && insuranceCoverage === 0"
            class="mt-4 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
            <div class="flex items-center">
                <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                <div>
                    <p class="text-sm font-semibold text-yellow-900">No Insurance Coverage</p>
                    <p class="text-xs text-yellow-700">Patient will pay full amount</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Services Selection Card -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden relative min-h-[300px]">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="text-2xl mr-2">üè•</span>
                Select Services
            </h3>
        </div>

        <!-- Section Loader -->
        <div *ngIf="isServicesLoading"
            class="absolute inset-x-0 bottom-0 top-[73px] bg-white/60 backdrop-blur-[2px] z-10 flex items-center justify-center">
            <div class="flex flex-col items-center">
                <mat-spinner diameter="45"></mat-spinner>
                <p class="mt-4 text-indigo-600 font-medium animate-pulse">Loading services...</p>
            </div>
        </div>

        <div class="overflow-x-auto" [class.opacity-40]="isServicesLoading">
            <table mat-table [dataSource]="services" class="w-full">
                <!-- Service Name Column -->
                <ng-container matColumnDef="service">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">
                        Service
                    </th>
                    <td mat-cell *matCellDef="let s" class="px-6 py-4">
                        <span class="font-medium text-gray-800">{{ s.serviceName }}</span>
                    </td>
                </ng-container>

                <!-- Cost Column -->
                <ng-container matColumnDef="cost">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">
                        Cost
                    </th>
                    <td mat-cell *matCellDef="let s" class="px-6 py-4">
                        <span class="text-lg font-bold text-indigo-600">‚Çπ{{ s.cost }}</span>
                    </td>
                </ng-container>

                <!-- Quantity Column -->
                <ng-container matColumnDef="qty">
                    <th mat-header-cell *matHeaderCellDef
                        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">
                        Quantity
                    </th>
                    <td mat-cell *matCellDef="let s" class="px-6 py-4">
                        <input type="number" min="0" max="10" [(ngModel)]="s.quantity" (ngModelChange)="calculateBill()"
                            class="w-20 px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none text-center font-semibold">
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                    class="hover:bg-indigo-50 transition-colors"></tr>
            </table>
        </div>

        <!-- No Services Found -->
        <div *ngIf="!isServicesLoading && services.length === 0" class="p-12 text-center text-gray-500 italic">
            No active services found in the master list.
        </div>
    </div>

    <!-- Bill Summary Card -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <span class="text-2xl mr-2">üí∞</span>
            Bill Summary
        </h3>

        <div class="space-y-4">
            <!-- Gross Amount -->
            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                <span class="text-gray-700 font-semibold">Gross Amount:</span>
                <span class="text-2xl font-bold text-blue-600">‚Çπ{{ grossAmount }}</span>
            </div>

            <!-- Insurance Deduction -->
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border-2 border-green-200">
                <span class="text-gray-700 font-semibold">Insurance Deduction ({{ insuranceCoverage }}%):</span>
                <span class="text-2xl font-bold text-green-600">-‚Çπ{{ insuranceAmount }}</span>
            </div>

            <!-- Net Payable -->
            <div
                class="flex items-center justify-between p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-300">
                <span class="text-lg font-bold text-gray-800">Net Payable:</span>
                <span class="text-4xl font-bold text-indigo-600">‚Çπ{{ netPayable }}</span>
            </div>
        </div>

        <!-- Generate Bill Button -->
        <div class="mt-6">
            <button mat-raised-button color="primary" (click)="generateBill()"
                [disabled]="!patientId || grossAmount === 0"
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 px-6 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95">
                <mat-icon class="mr-2">receipt</mat-icon>
                Generate Bill
            </button>
        </div>

        <div class="flex gap-4 mt-4">
            <button mat-raised-button color="primary" *ngIf="billResult" (click)="downloadInvoice()" class="flex-1">
                <mat-icon class="mr-2">download</mat-icon>
                Download PDF
            </button>
            <!-- <button mat-raised-button color="accent" *ngIf="billResult" (click)="emailInvoice()"
                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white border-none shadow-md">
                <mat-icon class="mr-2">email</mat-icon>
                Email Invoice
            </button> -->
        </div>

    </div>

    <!-- Payment Card (Shows after bill is generated) -->
    <div *ngIf="billResult" class="bg-white rounded-xl shadow-lg p-6 border-2 border-green-500">
        <div class="flex items-center mb-6">
            <div
                class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mr-4">
                <span class="text-4xl">‚úÖ</span>
            </div>
            <div>
                <h3 class="text-2xl font-bold text-gray-800">Bill Generated Successfully!</h3>
                <p class="text-gray-600">Proceed with payment</p>
            </div>
        </div>

        <!-- Bill Details -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-600">Bill ID:</p>
                    <p class="font-bold text-gray-800">{{ billResult.id || billResult.billId || 'N/A' }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Amount to Pay:</p>
                    <p class="font-bold text-green-600 text-xl">‚Çπ{{ netPayable }}</p>
                </div>
            </div>
        </div>

        <!-- Payment Button -->
        <button mat-raised-button color="accent" (click)="makePayment()"
            class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-4 px-6 rounded-lg hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-200 transform hover:scale-105 active:scale-95">
            <mat-icon class="mr-2">payment</mat-icon>
            Pay ‚Çπ{{ netPayable }} via UPI
        </button>
    </div>

    <!-- Info Card -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
        <div class="flex items-start">
            <mat-icon class="text-blue-600 mr-3">info</mat-icon>
            <div>
                <h3 class="text-lg font-semibold text-blue-900 mb-2">How it Works</h3>
                <ul class="text-blue-800 text-sm space-y-1">
                    <li>‚Ä¢ <strong>Step 1:</strong> Select a patient from the dropdown</li>
                    <li>‚Ä¢ <strong>Step 2:</strong> Choose services and enter quantities</li>
                    <li>‚Ä¢ <strong>Step 3:</strong> Insurance coverage is automatically applied if available</li>
                    <li>‚Ä¢ <strong>Step 4:</strong> Generate bill and proceed with payment</li>
                </ul>
            </div>
        </div>
    </div>
</div>